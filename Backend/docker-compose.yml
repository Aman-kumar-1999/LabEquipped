

version: '3.8'
services:
  service-registry:
    image: service-registry:latest
    container_name: service-registry
    build:
      context: ./service-registry
    ports:
      - "8761:8761"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 5s
      timeout: 2s
      retries: 5
    networks:
      - microservices-network

  config-server:
    image: config-server:latest
    container_name: config-server
    build:
      context: ./config-server
    ports:
      - "50000:50000"
    depends_on:
      service-registry:
        condition: service_healthy
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://service-registry:8761/eureka/
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:50000/actuator/health"]
      interval: 5s
      timeout: 2s
      retries: 5
    networks:
      - microservices-network

    

  product-service:
    image: product-service:latest
    container_name: product-service
    build:
      context: ./product-service
    ports:
      - "5004:5004"
    depends_on:
      service-registry:
        condition: service_healthy
      config-server:
        condition: service_healthy
    environment:
      - SPRING_PROFILES_ACTIVE=product
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:50000
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://service-registry:8761/eureka/
      - OPENAI_API_KEY=${OPENAI_API_KEY} # before start or deploying set the environment variable OPENAI_API_KEY
    networks:
      - microservices-network

  api-gateway:
    image: api-gateway:latest
    container_name: api-gateway
    build:
      context: ./api-gateway
    ports:
      - "5001:5001"
    depends_on:
      service-registry:
        condition: service_healthy
      config-server:
        condition: service_healthy
    environment:
      - SPRING_PROFILES_ACTIVE=apigateway
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:50000
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://service-registry:8761/eureka/
    networks:
      - microservices-network

  # 5️⃣ Redis
  redis:
    image: redis:latest
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - microservices-network

  # 6️⃣ Oracle DB (Free Developer Edition)
  oracle-db:
    image: container-registry.oracle.com/database/free:latest
    container_name: oracle-free
    ports:
      - "1521:1521"
    environment:
      - ORACLE_PASSWORD=root
      - APP_USER=labequiped
      - APP_USER_PASSWORD=root
    volumes:
      - oracle-data:/opt/oracle/oradata
    networks:
      - microservices-network

  # 7️⃣ User Service
  user-service:
    build: ./user-service
    container_name: user-service
    depends_on:
      service-registry:
        condition: service_healthy
      config-server:
        condition: service_healthy
      redis:
        condition: service_started
      oracle-db:
        condition: service_started
    ports:
      - "5002:5002"
    environment:
      - SPRING_PROFILES_ACTIVE=user
      - SPRING_DATASOURCE_URL=jdbc:oracle:thin:@//oracle-db:1521/FREEPDB1
      - SPRING_DATASOURCE_USERNAME=labequiped
      - SPRING_DATASOURCE_PASSWORD=root
      - SPRING_REDIS_HOST=redis
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:50000
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://service-registry:8761/eureka/
    networks:
      - microservices-network

networks:
  microservices-network:
    driver: bridge

volumes:
  oracle-data:






# version: '3.8'

# services:
#   service-registry:
#     build: ./service-registry
#     container_name: service-registry
#     ports:
#       - "8761:8761"
#     networks:
#       - microservices-net
#     healthcheck:
#       test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
#       interval: 5s
#       timeout: 2s
#       retries: 5
      
#   config-server:
#     build: ./config-server
#     container_name: config-server
#     depends_on:
#       service-registry:
#         condition: service_healthy
#     ports:
#       - "50000:50000"
#     environment:
#       - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://service-registry:8761/eureka/
#     networks:
#       - microservices-net
#     healthcheck:
#       test: ["CMD", "curl", "-f", "http://localhost:50000/actuator/health"]
#       interval: 5s
#       timeout: 2s
#       retries: 5
  

#   product-service:
#     build: ./product-service
#     container_name: product-service
#     depends_on:
#       service-registry:
#         condition: service_healthy
#       config-server:
#         condition: service_healthy
#     ports:
#       - "5004:5004"
#     environment:
#       - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://service-registry:8761/eureka/
#     networks:
#       - microservices-net

#   api-gateway:
#     build: ./api-gateway
#     container_name: api-gateway
#     depends_on:
#       service-registry:
#         condition: service_healthy
#       config-server:
#         condition: service_healthy
#     ports:
#       - "5001:5001"
#     environment:
#       - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://service-registry:8761/eureka/
#     networks:
#       - microservices-net

# networks:
#   microservices-net:
#     driver: bridge
